<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <title>Task Page: Online</title>
  </head>
  <body>
    <nav
      class="relative w-full flex flex-row items-center justify-between py-4 bg-gray-100 text-gray-500 hover:text-gray-700 focus:text-gray-700 shadow-lg navbar navbar-expand-lg navbar-light"
    >
      <div>
        <lottie-player
          class="ml-4 h-5 w-7"
          src="https://assets7.lottiefiles.com/private_files/lf30_eiaughgn.json"
          background="transparent"
          speed="0.5"
          autoplay
          loop
        ></lottie-player>
      </div>
      <div
        class="container-fluid w-full flex flex-wrap items-center justify-center px-6"
      >
        <div class="flex flex-row items-center justify-center mt-3 text-xl">
          Online Task Management System
        </div>
      </div>
      <div class="flex flex-row">
        <!-- Creating profile avatar and logout button -->
        <div
          class="flex flex-row"
          id="user"
          style="margin-right: 8px; display: flex; align-items: center"
        >
          <lottie-player
            class="h-5 w-5 mr-2"
            src="https://assets2.lottiefiles.com/packages/lf20_ia8jpabk.json"
            background="transparent"
            speed="0.5"
            autoplay
            loop
            hover
          ></lottie-player>
          <p id="currentUserName">admin</p>
        </div>

        <div id="logoutDiv" class="mr-6">
          <lottie-player
            class="h-12 w-12"
            src="https://assets8.lottiefiles.com/packages/lf20_s0cpca0v.json"
            background="transparent"
            speed="0.5"
            hover
          ></lottie-player>
        </div>
      </div>
    </nav>

    <div
      class="flex flex-row items-start justify-start bg-gray-100 text-gray-500 hover:text-gray-700 focus:text-gray-700"
    >
      <div class="flex flex-row">
        <a href="dashboard.html" class="block px-4 py-2 text-sm font-semibold"
          >Dashboard</a
        >
        <p class="block px-1 py-2 text-sm font-semibold">></p>
        <a
          id="projectNav"
          href="#"
          class="block px-4 py-2 text-sm font-semibold"
          >Projects</a
        >
        <p class="block px-1 py-2 text-sm font-semibold">></p>
        <a id="taskNav" class="block px-4 py-2 text-sm font-semibold">Tasks</a>
      </div>
    </div>
    <form class="w-full lg:w-2/3 mx-auto mb-10 mt-10">
      <div class="flex flex-wrap -mx-3 mb-6">
        <div class="w-full lg:w-1/4 md:w-full px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Task Name
          </label>
          <input
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white"
            id="task-name"
            type="text"
            placeholder="Task Name"
          />
        </div>
        <div class="w-full lg:w-3/4 md:w-1/2 px-3">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-last-name"
          >
            Task description
          </label>
          <textarea
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
            id="task-description"
            type="text"
            placeholder="Task Description"
          ></textarea>
        </div>
      </div>
      <div class="flex flex-wrap -mx-3 mb-2">
        <div class="w-full lg:w-1/2 md:w-1/3 px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-city"
          >
            Start Date
          </label>
          <input
            type="date"
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 mb-6 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
            id="start"
            type="text"
            placeholder="Albuquerque"
          />
        </div>
        <div class="w-full lg:w-1/2 md:w-1/3 px-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="enddate"
          >
            End Date
          </label>
          <input
            type="date"
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
            id="enddate"
            type="text"
            placeholder="Albuquerque"
          />
        </div>

        <div class="w-full lg:w-1/2 md:1/3 px-3 mb-6 md:mb-0">
          <label
            for="status"
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            >Status</label
          >
          <select
            id="status"
            name="status"
            autocomplete="status-name"
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
          >
            <option value="To Do">To Do</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
        </div>

        <div class="w-full lg:w-1/2 md:1/3 px-3 mb-6 md:mb-0">
          <label
            for="status"
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            >Assignee</label
          >
          <select
            id="assignee"
            name="status"
            autocomplete="status-name"
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
          ></select>
        </div>

        <div class="w-full lg:w-2/4 md:w-full p-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Hourly Rate
          </label>
          <input
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border border-gray-200 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white"
            id="hourly_rate"
            type="number"
            placeholder="Eg. 15"
          />
        </div>

        <div class="w-full lg:w-2/4 md:w-full p-3 mb-6 md:mb-0">
          <label
            class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
            for="grid-first-name"
          >
            Total Hour Worked
          </label>
          <input
            class="appearance-none block w-full bg-gray-200 text-gray-700 border border border-gray-200 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white"
            id="total_hours_worked"
            type="number"
            placeholder="Eg. 5"
          />
        </div>
        <div
          class="w-full lg:full md:full mt-6 px-3 mb-6 md:mb-0 flex flex-row justify-evenly"
        >
          <button
            id="save"
            class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          >
            Save
          </button>
          <button
            id="deleteTask"
            class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          >
            Delete
          </button>
        </div>
      </div>
    </form>
  </body>
  <script>
    // log out when clicked on logOut div
    document
      .getElementById("logoutDiv")
      .addEventListener("click", function (event) {
        window.location.href = "index.html";
      });

    if (getCurrentUser() == null) {
      window.location.href = "index.html";
    } else {
      document.getElementById("currentUserName").innerHTML =
        getCurrentUser().name;
      if (getCurrentUser().type != "admin") {
        // TODO: make hourly rate uneditable
        document.getElementById("hourly_rate").disabled = true;

        // make assignee uneditable
        document.getElementById("assignee").disabled = true;

        // make task name and task description uneditable
        document.getElementById("task-name").disabled = true;
        document.getElementById("task-description").disabled = true;

        // make start date date uneditable
        document.getElementById("start").disabled = true;

        // document.getElementById("save").classList.add("hidden");
      }
    }

    function getCurrentUser() {
      var currentUser = JSON.parse(localStorage.getItem("currentUser"));
      return currentUser;
    }

    // parsing task id and project id from url
    function getUrlVars() {
      var vars = {};
      var parts = window.location.href.replace(
        /[?&]+([^=&]+)=([^&]*)/gi,
        function (m, key, value) {
          vars[key] = value;
        }
      );
      console.log(vars);
      return vars;
    }
    var values = getUrlVars();
    // getting the first character of values
    var project_id = Number(values["projectId"]);

    // getting the last character of values
    var task_id = Number(values["taskId"]);

    console.log("projectid" + values["projectId"]);
    console.log("taskid" + values["taskId"]);

    var project = getProjectDetails();

    var tasks = project.tasks;

    var task = tasks.find((t) => t.id == task_id);

    // TODO: We need to redirect when we click on project navbar item to project.html with project id
    document.getElementById("projectNav").innerHTML = project.name;
    // Redirecting to project.html with project id
    document.getElementById("projectNav").href =
      "project.html?projectId=" + project.id;

    document.getElementById("taskNav").innerHTML = task.name;
    // Redirecting to task.html with project id and task id
    // document.getElementById("taskNav").href =
    //   "task.html?projectId=" + project.id + task.id;

    function getUsers() {
      var users = JSON.parse(localStorage.getItem("users"));
      return users;
    }

    function getProjectDetails() {
      var projects = JSON.parse(localStorage.getItem("projects"));
      var project = projects.find((p) => p.id == project_id);
      console.log(project);
      return project;
    }

    var users = getUsers();
    var assignee = document.getElementById("assignee");
    users.forEach((user) => {
      var option = document.createElement("option");
      option.value = user.id;
      option.text = user.name;
      assignee.appendChild(option);
    });

    document.getElementById("task-name").value = task.name;
    document.getElementById("task-description").value = task.description;
    document.getElementById("start").value = task.startDate
      .split("/")
      .reverse()
      .join("-");
    document.getElementById("enddate").value = task.endDate
      .split("/")
      .reverse()
      .join("-");
    // getting task status and assignee and setting it to the dropdown
    document.getElementById("status").value = task.status;
    document.getElementById("assignee").value = task.assignee;
    document.getElementById("hourly_rate").value = task.hourlyRate;
    document.getElementById("total_hours_worked").value = task.totalHoursWorked;

    function getUserFullNameFromId(userId) {
      var users = JSON.parse(localStorage.getItem("users"));
      var user = users.find((u) => u.id == userId);
      return user.name;
    }

    var save = document.getElementById("save");
    save.addEventListener("click", function () {
      // prevent default form submission
      event.preventDefault();
      var taskName = document.getElementById("task-name");
      var description = document.getElementById("task-description");
      var startDate = document.getElementById("start");
      var endd = document.getElementById("enddate");
      task.status = document.getElementById("status").value;
      task.assignee = Number(document.getElementById("assignee").value);

      task.name = taskName.value;

      task.description = description.value;

      task.startDate = startDate.value;

      task.endDate = endd.value;
      task.hourlyRate = Number(document.getElementById("hourly_rate").value);
      task.totalHoursWorked = Number(
        document.getElementById("total_hours_worked").value
      );

      console.log(task);

      // updating the task in the project
      var taskIndex = tasks.findIndex((t) => t.id == task_id);
      tasks[taskIndex] = task;

      // updating the project in the projects
      // getting the projects from the local storage
      var projects = JSON.parse(localStorage.getItem("projects"));
      var projectIndex = projects.findIndex((p) => p.id == project_id);
      projects[projectIndex] = project;

      // updating the projects in the local storage
      localStorage.setItem("projects", JSON.stringify(projects));

      // Showing the success alert
      alert("Task updated successfully");

      // reload the page
      location.reload();
    });

    var deleteTask = document.getElementById("deleteTask");
    deleteTask.addEventListener("click", function () {
      // prevent default form submission
      event.preventDefault();

      // deleting the task from the project
      var taskIndex = tasks.findIndex((t) => t.id == task_id);
      tasks.splice(taskIndex, 1);

      // updating the project in the projects
      // getting the projects from the local storage
      var projects = JSON.parse(localStorage.getItem("projects"));
      var projectIndex = projects.findIndex((p) => p.id == project_id);
      projects[projectIndex] = project;

      // updating the projects in the local storage
      localStorage.setItem("projects", JSON.stringify(projects));

      // Showing the success alert
      alert("Task deleted successfully");

      // redirecting to project.html
      window.location.href = "project.html?projectId=" + project_id;
    });
  </script>
</html>
