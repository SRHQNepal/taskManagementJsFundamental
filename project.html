<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdn.tailwindcss.com"></script>
         <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <title>Project</title>
  </head>
  <body>
    <nav
      class="relative w-full flex flex-row items-center justify-between py-4 bg-gray-100 text-gray-500 hover:text-gray-700 focus:text-gray-700 shadow-lg navbar navbar-expand-lg navbar-light"
    >
    <div>
      <lottie-player class="ml-4 h-5 w-7" src="https://assets7.lottiefiles.com/private_files/lf30_eiaughgn.json" background="transparent"  speed="0.5" autoplay loop></lottie-player>
    </div>
      <div
        class="container-fluid w-full flex flex-wrap items-center justify-center px-6"
      >
        <div class="flex flex-row items-center justify-center mt-3">
          Online Task Management System
        </div>
      </div>
      <div class="flex flex-row">
        <!-- Creating profile avatar and logout button -->
        <div class="flex flex-row" id="user" style="margin-right: 8px;display: flex;align-items: center;">
        <lottie-player class="h-5 w-5 mr-2" src="https://assets2.lottiefiles.com/packages/lf20_ia8jpabk.json" background="transparent"  speed="0.5" autoplay loop hover></lottie-player>
        <p id="currentUserName">admin</p>
        </div>
       
      <div id="logoutDiv" class="mr-6">
       <lottie-player class="h-12 w-12" src="https://assets8.lottiefiles.com/packages/lf20_s0cpca0v.json" background="transparent"  speed="0.5" hover></lottie-player>
      </div>
      </div>
    </nav>

    <div>
       <!-- Creating navbar to create the project -->
      <div class="flex flex-row items-start justify-start bg-gray-100 text-gray-500 hover:text-gray-700 focus:text-gray-700">
        <div class="flex flex-row">
          <a
            href="dashboard.html"
            class="block px-4 py-2 text-sm font-semibold "
            >Dashboard</a
          >
          <p class="block px-1 py-2 text-sm font-semibold ">></p>
          <a
          id="projectNav"
            href="#"
            class="block px-4 py-2 text-sm font-semibold "
            >Projects</a
          >
        </div>
      </div>
      <form class="w-full  lg:w-2/3  mx-auto mb-10 mt-10">
        <div class="flex flex-wrap -mx-3 mb-6">
          <div class="w-full lg:w-1/4 md:w-full px-3 mb-6 md:mb-0">
            <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="project_name">
             Project Name
            </label>
            <input class="appearance-none block w-full bg-gray-200 text-gray-700 border border-red-500 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white" type="text" id="project_name" placeholder="Jane">
           
          </div>
          <div class="w-full lg:w-3/4 md:w-1/2 px-3">
            <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="project_description">
              Project description
            </label>
            <textarea class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" type="text" placeholder="Doe" id="project_description"></textarea>
          </div>
        </div>
        <div class="flex flex-wrap -mx-3 mb-2 items-center justify-center">
          <div class="w-full lg:w-1/2 md:w-1/3 px-3 mb-6 md:mb-0">
            <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="start_date">
              Start Date
            </label>
            <input type="date" class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" type="text" placeholder="Albuquerque" id="start_date">
          </div>
          <div class="w-full lg:w-1/2 md:w-1/3 px-3 mb-6 md:mb-0">
            <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="end_date">
              End Date
            </label>
            
            <input type="date" class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" type="text" placeholder="Albuquerque" id="end_date">
          </div>
         <!--  <lottie-player class="h-12 w-12" src="https://assets8.lottiefiles.com/packages/lf20_s0cpca0v.json" background="transparent"  speed="0.5" hover></lottie-player> -->
         <div class="w-full lg:full md:full mt-6 px-3 mb-6 md:mb-0">
          <button  type="button" id="save" class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" onclick="projectUpdate()">Update</button>
        </div> 
        </div>

      </form>
      <!-- Creating input to create the project -->
      <div class="flex flex-row items-center justify-center mt-10">
        <div class="flex flex-row p-2  w-1/2">
            <input
              id="taskName"
              type="text"
              class="form-control block w-full px-4 py-2 text-xl font-normal text-gray-700 bg-white bg-clip-padding shadow-md rounded transition ease-in-out m-0 focus:text-gray-700 outline-none"
              placeholder="Type to create task"
            />
            </div>

    </div>
    <div class="flex flex-row items-center justify-center mt-10">
      <table id="tasksTable" class="table-auto shadow-md w-11/12 p-5"
      ></table>
    </div>

    <script>
      // log out when clicked on logOut div
      document.getElementById("logoutDiv").addEventListener("click", function (event) {
        window.location.href = "index.html";
      });

      var project = getProjectDetails();
    // getting curent user  
    var currentUser = JSON.parse(localStorage.getItem("currentUser"));

    // getting all users
    var users = JSON.parse(localStorage.getItem("users"));

    if (getCurrentUser() == null) {
        window.location.href = "index.html";
      }else{
        document.getElementById("currentUserName").innerHTML = getCurrentUser().name;
        if (getCurrentUser().type != "admin") {
          document.getElementById("createProjectDiv").classList.add("hidden");
        }
      }

    function getCurrentUser() {
      var currentUser = JSON.parse(localStorage.getItem("currentUser"));
      return currentUser;
    }

    function getProjectDetails() {
      var projects = JSON.parse(localStorage.getItem("projects"));
      var projectId = getUrlVars()["projectId"];
      var project = projects.find(p => p.id == projectId);
      console.log(project);
      return project;
    }

    // getting project id from url
    function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                vars[key] = value;
            });
            return vars;
        }

    var projectId = getUrlVars()["projectId"];

    document.addEventListener("DOMContentLoaded", function() {
    tasks = project.tasks;

      // getting current date 
    // TODO:
    // fill project details
    // filling the project details in input tag

    var startDate = new Date().toISOString().slice(0, 10);
    var endDate = new Date().toISOString().slice(0, 10);
    if((project.startDate !='') && (project.startDate !=undefined)){
      startDate = project.startDate;
    }
    if((project.endDate !='') && (project.endDate != undefined)){
      endDate = project.endDate;
    
    } 
    document.getElementById("project_name").value = project.name;
    document.getElementById("project_description").value = project.description;
    document.getElementById("start_date").value = startDate;
    document.getElementById("end_date").value = endDate;
   
    // TODO: We need to redirect when we click on project navbar item to project.html with project id
    document.getElementById("projectNav").innerHTML = project.name;
    // document.getElementById("projectDescription").innerHTML = project.description;
    // document.getElementById("projectStartDate").innerHTML = project.startDate;
    // document.getElementById("projectEndDate").innerHTML = project.endDate;


            // creating table for tasks
    fillTasksTable();
        document.title = project.name + ": Online Task Management System";
    });

    // focusing on the text bar for adding task
    document.getElementById("taskName").focus();



     function fillElementsOfTable(itemsWhereToAppend, whatToAppend){

        // Creating headers for the table
        var taskRow = document.createElement("tr");
        var taskId = document.createElement("th");
        var taskName = document.createElement("th");
        var taskDescription = document.createElement("th");
        var taskOverallStatus = document.createElement("th");
        var taskAssignee = document.createElement("th");
        var taskTotalHours = document.createElement("th");
        var taskTotalCost = document.createElement("th");
        // create a dropdown for assignee
        // var assigneeDropdown = document.createElement("select");
        // assigneeDropdown.innerHTML = "<option value=''>Please Select</option>";
        // create options for the dropdown
       


        taskId.innerHTML = whatToAppend.firstItem;
        taskName.innerHTML = whatToAppend.secondItem;
        taskDescription.innerHTML = whatToAppend.thirdItem;
        taskOverallStatus.innerHTML = whatToAppend.fourthItem;
        // print the type of tbody or thead
        console.log(itemsWhereToAppend.tagName);
        taskAssignee.innerHTML = whatToAppend.fifthItem;
        taskTotalHours.innerHTML = whatToAppend.sixthItem;
        taskTotalCost.innerHTML = whatToAppend.seventhItem;

        taskRow.appendChild(taskId);
        taskRow.appendChild(taskName);
        taskRow.appendChild(taskDescription);
        taskRow.appendChild(taskOverallStatus);
        taskRow.appendChild(taskAssignee);
        taskRow.appendChild(taskTotalHours);
        taskRow.appendChild(taskTotalCost);

        itemsWhereToAppend.appendChild(taskRow);
      }

      function fillTasksTable() {

        var tasksTable = document.getElementById("tasksTable");
        var taskTableHead = document.createElement("thead");
        var taskTableBody = document.createElement("tbody");

        // Clear the table first
        tasksTable.innerHTML = "";


        contentsToAppend = {
          firstItem: "ID",
          secondItem: "NAME",
          thirdItem: "DESCRIPTION",
          fourthItem:  "STATUS",
          fifthItem: "ASSIGNEE",
          sixthItem: "TOTAL HOURS",
          seventhItem: "TOTAL COST"
        }
        fillElementsOfTable(taskTableHead, contentsToAppend);
        console.log(tasks);
        tasks.forEach((task) => {
            console.log(task);
          contentsToAppend = {
            firstItem: task.id ? task.id : "",
            secondItem: task.name,
            thirdItem: task.description,
            fourthItem: task.status ? task.status : "",
            fifthItem: task.assignee ? getUserFullNameFromId(task.assignee) : "",
            sixthItem: task.totalHoursWorked ? task.totalHoursWorked : "",
            seventhItem: task.hourlyRate ? "$ "+  (task.totalHoursWorked ? task.totalHoursWorked : 0) *  task.hourlyRate: ""
          }
          fillElementsOfTable(taskTableBody, contentsToAppend);
        });
        tasksTable.appendChild(taskTableHead);
        tasksTable.appendChild(taskTableBody);
        loadEventHandlers();
      }

      function getUserFullNameFromId(userId) {
        var users = JSON.parse(localStorage.getItem("users"));
        var user = users.find(u => u.id == userId);
        return user.name;
      }

      function loadEventHandlers() {
        // Adding event handlers to the table rows
        var tableRows = document.getElementById("tasksTable").rows;
        for (var i = 1; i < tableRows.length; i++) {
          tableRows[i].addEventListener("click", function () {
            console.log("Row clicked");
            console.log(this.cells[0].innerHTML);
            // redirect to the task page
           window.location.href = "task.html?projectId="+projectId+"&taskId=" + this.cells[0].innerHTML;
          });
        }

        // Adding event handlers to add tasks when pressing enter
        document.getElementById("taskName").addEventListener("keyup", function (event) {
          if (event.keyCode === 13) {
            event.preventDefault();
            console.log("Enter pressed");
            addTask();
          }
        });
      }

      function addTask() {
        var taskName = document.getElementById("taskName").value;
        var task = {
          id: tasks.length + 1,
          name: taskName,
          description: "",
          status: "incomplete",
          assignee: "",
          totalHoursWorked: 0,
          hourlyRate: 0,
        }
        tasks.push(task);
       
        // Storing the tasks in the project
        project.tasks = tasks;

        // fetching the projects from local storage
        var projects = JSON.parse(localStorage.getItem("projects"));
        // updating the project in the projects
        for (var i = 0; i < projects.length; i++) {
            if (projects[i].id == projectId) {
                projects[i] = project;
            }
        }

        // update the project in local storage
        localStorage.setItem("projects", JSON.stringify(projects));
       

        console.log(tasks);
        fillTasksTable();
        document.getElementById("taskName").value = "";
        document.getElementById("taskDescription").value = "";
        document.getElementById("taskStatus").value = "";
        document.getElementById("taskAssignee").value = "";
        document.getElementById("taskName").focus();
      }

      function projectUpdate(){
        var projectName = document.getElementById('project_name').value;
        var projectDescription = document.getElementById('project_description').value;
        var startDate = document.getElementById('start_date').value;
        var endDate   = document.getElementById('end_date').value;

        console.log(projectName);
        console.log(projectDescription);
        console.log(startDate);
        console.log(endDate);
        var projectId = getUrlVars()["projectId"];
        var projects = JSON.parse(localStorage.getItem("projects"));
        var projectDetail = projects.find(p => p.id == projectId);
        console.log(projectId);
        console.log(projects);
        for (var i = 0; i < projects.length; i++) {
            if (projects[i].id == projectId) {
                projects[i].id = projectId;
                projects[i].name = projectName;
                projects[i].description = projectDescription;
                projects[i].startDate = startDate;
                projects[i].endDate = endDate;
            }
        }
        localStorage.setItem("projects", JSON.stringify(projects));

        alert("Project Updated Successfully");

        // reload the page
        window.location.href = "project.html?projectId="+projectId;
      }

    </script>
  </body>
</html>